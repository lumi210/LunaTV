# Requirements Document

## Introduction

本文档定义了推广模式与运营模式切换功能的需求规格说明。该功能允许管理员在管理面板中切换系统运行模式：推广模式下，新用户注册时系统自动生成并绑定一张指定类型的卡密，无需用户手动填写，注册页面也不显示卡密输入项；运营模式下，保持现有的注册机制不变，用户需要手动输入卡密才能完成注册。

## Glossary

- **推广模式（Promotion Mode）**: 系统运行模式之一，新用户注册时系统自动生成并绑定指定类型卡密，简化注册流程
- **运营模式（Operation Mode）**: 系统运行模式之一，保持现有注册机制，用户需手动输入卡密
- **系统模式（System Mode）**: 系统当前运行的模式状态，存储在配置中
- **自动生成卡密**: 系统在推广模式下为注册用户实时生成卡密并绑定的行为
- **推广卡密类型**: 管理员配置的、推广模式下自动生成卡密的类型（1周/1月/1季/1年）
- **欢迎栏**: 用户登录后系统界面顶部显示的欢迎信息区域
- **卡密延期**: 用户通过邀请好友获得积分并兑换卡密来延长账户有效期

## Requirements

### Requirement 1: 管理员模式设置界面

**User Story:** AS 管理员, I want 在管理面板中设置系统运行模式, so that 可以灵活控制用户注册流程

#### Acceptance Criteria

1. WHEN 管理员访问管理面板, 系统 SHALL 在卡密管理区域显示模式设置选项
2. WHEN 管理员查看模式设置, 系统 SHALL 提供推广模式和运营模式两个选项供选择
3. WHEN 管理员选择推广模式, 系统 SHALL 显示推广卡密类型配置项（1周/1月/1季/1年）
4. WHEN 管理员选择模式并保存, 系统 SHALL 将模式设置和推广卡密类型持久化到系统配置中
5. WHEN 模式设置保存成功, 系统 SHALL 显示成功提示并刷新当前配置状态

### Requirement 2: 推广模式下的注册流程

**User Story:** AS 新用户, I want 在推广模式下无需输入卡密即可注册, so that 注册流程更加便捷

#### Acceptance Criteria

1. WHEN 系统处于推广模式且用户访问注册页面, 系统 SHALL 不显示卡密输入项
2. WHEN 系统处于推广模式且用户提交注册请求, 系统 SHALL 自动为用户生成并绑定一张指定类型的卡密
3. WHEN 系统自动生成卡密, 系统 SHALL 根据管理员配置的类型（1周/1月/1季/1年）生成
4. WHEN 系统自动绑定卡密成功, 系统 SHALL 将该卡密记录为已使用并关联到新用户
5. WHEN 系统自动生成卡密失败, 系统 SHALL 返回错误提示并拒绝注册

### Requirement 3: 运营模式下的注册流程

**User Story:** AS 新用户, I want 在运营模式下按现有流程注册, so that 系统行为保持一致和可预期

#### Acceptance Criteria

1. WHEN 系统处于运营模式且用户访问注册页面, 系统 SHALL 显示卡密输入项
2. WHEN 系统处于运营模式且用户提交注册请求, 系统 SHALL 验证用户提供的卡密
3. WHEN 卡密验证通过, 系统 SHALL 按现有逻辑完成用户注册并绑定卡密
4. WHEN 卡密验证失败, 系统 SHALL 返回相应错误信息并拒绝注册

### Requirement 4: 推广卡密类型配置

**User Story:** AS 管理员, I want 配置推广模式下自动赠送的卡密类型, so that 可以灵活控制推广策略

#### Acceptance Criteria

1. WHEN 管理员在推广模式设置页面, 系统 SHALL 提供卡密类型选择（1周/1月/1季/1年）
2. WHEN 管理员选择卡密类型, 系统 SHALL 显示该类型的有效期说明
3. WHEN 管理员保存配置, 系统 SHALL 记录推广卡密类型设置
4. WHEN 系统生成推广卡密, 系统 SHALL 使用配置的类型创建卡密

### Requirement 5: 模式切换兼容性

**User Story:** AS 系统, I want 模式切换不影响已有用户, so that 系统运行稳定

#### Acceptance Criteria

1. WHEN 管理员切换系统模式, 系统 SHALL 不影响已注册用户的卡密状态
2. WHEN 系统从推广模式切换到运营模式, 系统 SHALL 不改变已自动绑定的卡密
3. WHEN 系统从运营模式切换到推广模式, 系统 SHALL 不改变用户已手动绑定的卡密
4. WHEN 模式切换成功, 系统 SHALL 记录切换日志包含切换时间和操作人

### Requirement 6: 注册API适配

**User Story:** AS 系统, I want 注册API根据当前模式处理请求, so that 前后端行为一致

#### Acceptance Criteria

1. WHEN 注册API收到请求, 系统 SHALL 首先查询当前系统模式配置
2. WHEN 系统处于推广模式且用户未提供卡密, 系统 SHALL 自动生成并绑定卡密
3. WHEN 系统处于运营模式且用户未提供卡密, 系统 SHALL 返回卡密不能为空的错误
4. WHEN 系统处于推广模式且用户提供了卡密, 系统 SHALL 优先使用用户提供的卡密

### Requirement 7: 卡密使用统计

**User Story:** AS 管理员, I want 查看推广模式下生成的卡密统计, so that 了解推广效果

#### Acceptance Criteria

1. WHEN 管理员查看卡密管理页面, 系统 SHALL 显示通过推广模式自动生成的卡密数量
2. WHEN 管理员筛选卡密来源, 系统 SHALL 支持按推广注册和手动绑定分类查看
3. WHEN 管理员查看卡密详情, 系统 SHALL 显示卡密的来源类型

### Requirement 8: 推广模式用户欢迎栏到期提醒

**User Story:** AS 推广模式下注册的用户, I want 在欢迎栏看到账户7日后到期的提示和推荐好友获取卡密延期的引导, so that 可以提前了解账户状态并采取行动

#### Acceptance Criteria

1. WHEN 推广模式下注册的用户登录系统, 系统 SHALL 在欢迎栏显示"账户将于7日后到期"的提示
2. WHEN 显示到期提示, 系统 SHALL 同时显示"推荐好友获取卡密延期"的引导信息
3. WHEN 用户点击推荐好友引导, 系统 SHALL 跳转到推广码分享页面或积分兑换页面
4. WHEN 用户的卡密来源为推广注册, 系统 SHALL 自动识别并显示7天到期提示
5. WHEN 用户的卡密已延期, 系统 SHALL 更新欢迎栏显示新的到期日期

### Requirement 9: 普通用户欢迎栏卡密到期日期显示

**User Story:** AS 已绑定卡密的普通用户, I want 在欢迎栏看到卡密的到期日期, so that 可以清楚了解账户的有效期

#### Acceptance Criteria

1. WHEN 已绑定卡密的用户登录系统, 系统 SHALL 在欢迎栏显示"卡密到期日期: YYYY-MM-DD"
2. WHEN 用户绑定了多张卡密, 系统 SHALL 显示最晚到期的卡密日期
3. WHEN 卡密到期日期为当天, 系统 SHALL 显示"卡密今日到期"的紧急提示
4. WHEN 卡密已过期, 系统 SHALL 显示"卡密已过期"并阻止用户访问系统功能
5. WHEN 用户绑定新卡密, 系统 SHALL 立即更新欢迎栏的到期日期显示

## Constraints

1. **权限限制**: 只有 owner 和 admin 角色可以修改系统模式设置
2. **向后兼容**: 默认模式为运营模式，确保升级后系统行为不变
3. **卡密来源标识**: 自动生成的推广卡密需标记来源为推广注册

## Assumptions

1. 系统已实现完整的卡密管理功能
2. 卡密数据结构和绑定逻辑已稳定运行
3. 管理面板的卡密管理区域已存在
