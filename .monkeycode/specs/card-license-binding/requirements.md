# 卡密功能需求文档

## 引言

LunaTV Enhanced Edition 需要引入卡密（Activation Card）机制，以便通过具有有效期的卡密来控制普通用户账号的使用期限，并提供统一的后台管理与到期提醒体验。本需求文档使用 EARS 模式描述可测试的验收标准，确保功能实现覆盖注册、登录、提醒、重新绑定以及后台运维场景。

## 术语表

- **Activation Card（卡密）**：包含唯一编码、有效期类型（1 周、1 月、1 季度、1 年等）和可用状态的凭证，用于授权普通账号访问。
- **绑定卡密**：用户向系统提交卡密，系统验证卡密可用后将其关联到用户账号并记录到期时间。
- **到期宽限期**：卡密失效后系统不提供宽限期，即刻阻止普通账号登录。
- **管理员账号**：具有后台权限且不受卡密限制的账号类型。
- **通知渠道**：站内消息或邮件（若已配置）等系统现有的用户提醒方式。

## 需求

### 需求 R1：注册绑定卡密

**用户故事：** 作为新注册用户，我希望在注册时绑定一个有效卡密，以便在账号创建后立即获得访问权限。

#### 验收标准

1. WHEN 用户在注册表单提交时提供卡密，THE 系统 SHALL 校验卡密的格式、未使用状态与有效期并在成功后创建账号。
2. IF 卡密无效、已使用或超出有效期，THE 系统 SHALL 阻止账号创建并返回明确的错误提示。
3. WHEN 注册流程完成，THE 系统 SHALL 将卡密与用户账号关联并记录到期日期。

### 需求 R2：卡密有效期与账号访问控制

**用户故事：** 作为普通用户，我希望卡密的有效期被严格执行，以便在到期后自动失去访问权限，确保系统授权可控。

#### 验收标准

1. WHILE 卡密仍在有效期内，THE 系统 SHALL 允许用户正常登录并访问授权功能。
2. WHEN 当前时间超过卡密到期时间，THE 系统 SHALL 阻止用户登录并显示需要重新绑定卡密的提示。
3. IF 用户拥有多个卡密，THE 系统 SHALL 以最近一次绑定且仍有效的卡密计算到期时间。

### 需求 R3：到期提醒与重新绑定

**用户故事：** 作为普通用户，我希望卡密即将到期时获得提醒，并可在设置页面重新绑定卡密，以避免服务中断。

#### 验收标准

1. WHEN 距离卡密到期时间还有 30 天，THE 系统 SHALL 通过通知渠道向用户发送到期提醒并在设置页显示提醒状态。
2. WHEN 用户在设置页面提交新的卡密，THE 系统 SHALL 验证并在成功后更新账号的卡密绑定与到期时间。
3. IF 用户尝试绑定无效或已使用的卡密，THE 系统 SHALL 保留原卡密状态并给出失败原因。

### 需求 R4：管理员账号豁免

**用户故事：** 作为管理员，我希望账号不受卡密限制，以确保后台运营管理不会被阻断。

#### 验收标准

1. WHILE 账号角色为管理员，THE 系统 SHALL 允许其登录并访问后台，即使未绑定卡密。
2. IF 管理员账号绑定了卡密，THE 系统 SHALL 不根据卡密到期限制其访问，但仍记录卡密信息用于审计。

### 需求 R5：卡密后台管理

**用户故事：** 作为管理员，我希望在后台对卡密进行全生命周期管理，以便批量发放、禁用或追踪使用情况。

#### 验收标准

1. WHEN 管理员访问后台卡密管理模块，THE 系统 SHALL 显示卡密列表（卡密编号、有效期类型、到期时间、使用状态、绑定用户、创建者）。
2. WHEN 管理员创建卡密，THE 系统 SHALL 允许设置有效期类型、可用次数（单次或预留扩展）和备注，并生成唯一编码。
3. WHEN 管理员禁用某卡密，THE 系统 SHALL 立即阻止该卡密的后续使用并通知已绑定用户按照 R3 的提醒规则重新绑定。
